use jwt::JWT;

global MAX_DATA_LENGTH: u32 = 900; // max length of signed data (headerb64 + "." + payloadb64)
global MAX_NONCE_LENGTH: u32 = 32; // we are verifying `nonce` claim

fn main(
    email: BoundedVec<u8, 35>,
    data: BoundedVec<u8, MAX_DATA_LENGTH>,
    base64_decode_offset: u32,
    pubkey_modulus_limbs: pub [u128; 18],
    redc_params_limbs: [u128; 18],
    signature_limbs: [u128; 18],
    // expected_nonce: pub BoundedVec<u8, MAX_NONCE_LENGTH>,
) {
    let jwt = JWT::init(
        data,
        base64_decode_offset,
        pubkey_modulus_limbs,
        redc_params_limbs,
        signature_limbs,
    );

    jwt.verify();

    // Verify `iss` claim value is "test"
    jwt.assert_claim_string("email".as_bytes(), email);
}

#[test]
fn test_jwt_verification() {
    // Email from the JWT payload
    let email: BoundedVec<u8, 35> = BoundedVec::from_array("john.doe@example.com".as_bytes());

    // JWT data (header + "." + payload)
    let mut jwt_data_array = [0 as u8; MAX_DATA_LENGTH];
    let jwt_bytes = [
        101, 121, 74, 104, 98, 71, 99, 105, 79, 105, 74, 83, 85, 122, 73, 49, 78, 105, 73, 115, 73,
        110, 82, 53, 99, 67, 73, 54, 73, 107, 112, 88, 86, 67, 74, 57, 46, 101, 121, 74, 122, 100,
        87, 73, 105, 79, 105, 73, 120, 77, 106, 77, 48, 78, 84, 89, 51, 79, 68, 107, 119, 73, 105,
        119, 105, 90, 87, 49, 104, 97, 87, 119, 105, 79, 105, 74, 113, 98, 50, 104, 117, 76, 109,
        82, 118, 90, 85, 66, 108, 101, 71, 70, 116, 99, 71, 120, 108, 76, 109, 78, 118, 98, 83, 73,
        115, 73, 109, 70, 107, 98, 87, 108, 117, 73, 106, 112, 48, 99, 110, 86, 108, 76, 67, 74,
        112, 89, 88, 81, 105, 79, 106, 69, 49, 77, 84, 89, 121, 77, 122, 107, 119, 77, 106, 74, 57,
    ];

    for i in 0..145 {
        jwt_data_array[i] = jwt_bytes[i];
    }
    let data: BoundedVec<u8, MAX_DATA_LENGTH> = BoundedVec::from_array(jwt_data_array);

    let base64_decode_offset: u32 = 37;

    let pubkey_modulus_limbs: [u128; 18] = [
        779496072868262201011239649910301785,
        391942738017319124951134579751716550,
        762091151624561202375224348763461393,
        731041473413279882916283174195302795,
        836265260260721436712253195900525742,
        539984885285781271730729293148223059,
        713626733663871590205869171263817640,
        551533037269611523978995812391937205,
        614735196356432702606117821829906201,
        847327520176354992618251638932406338,
        924704881924480335790238817661886452,
        852777544676707778214284078795106341,
        834894255811612218905838794753753353,
        375342711802255523303277403591591372,
        785792265337792656705703776745300720,
        108134379556498659893583504309286111,
        41600853556824724830999101633713158,
        157,
    ];

    let redc_params_limbs: [u128; 18] = [
        577015309818103504256988616614164297,
        1123036575478831898294892864481602706,
        811227878748078229718548717927879636,
        794815595446498465801456681945752492,
        510546467055037932720624126530718592,
        384326325601250123251780105439623999,
        271920996771638632995433636850526726,
        18618526391898395009062388199824872,
        710957906696022914544308937346394285,
        601954590248276208008432871434679374,
        603850138908214657423702651913720706,
        835476480741607978102202788740030129,
        569809416354180861799710791502492165,
        1175983497022142220844859685170361183,
        730040669651105854754983520214910865,
        414419690801305463975621998710705976,
        660502317502231277075651133736748280,
        6677,
    ];

    let signature_limbs: [u128; 18] = [
        766953124949767847411868597117480320,
        535532931712469041890114758564367024,
        188792707670771699103690671328052154,
        934661188550924548606699616802593694,
        623419153945922084691211349303133457,
        1017952023478663749952613724569423785,
        1206659937507439392838320885145615572,
        526874958404313748776345648769556772,
        264558765918441125171895791614927315,
        1110101231201943479945161383549962035,
        268878571950995030472963201804182430,
        806976940621271889531831143769032307,
        1049287484793751412622071274857888240,
        871489693873000230387719020886295388,
        940551132561621336073324236340864760,
        995309537096568169987912737154195086,
        801402077250750963127226561848253038,
        108,
    ];

    // Expected nonce - empty for this test
    let expected_nonce: BoundedVec<u8, MAX_NONCE_LENGTH> = BoundedVec::new();

    main(
        email,
        data,
        base64_decode_offset,
        pubkey_modulus_limbs,
        redc_params_limbs,
        signature_limbs,
        // expected_nonce
    );
}
