use jwt::JWT;

global MAX_DATA_LENGTH: u32 = 900; // max length of signed data (headerb64 + "." + payloadb64)

global PUBKEY_MOD_LIMBS: [u128; 18] = [
    515663237686833669869810499344001243,
    953819238553497717755434724776855175,
    1048822860653528211954030209295249526,
    517513751351976829780724099758150477,
    48791761226051143683612477849785362,
    1130782172224543703604425222079974585,
    642042802634725937933688324853987568,
    344200317815765072757349502644388433,
    53327874793283723515895453997890991,
    873854409709998152458621264011074925,
    547833624793294868525458248334488144,
    1080231326270882706368409932372831781,
    960377708360397727904579347842729739,
    214892724087127096984947015961165726,
    758482441690157368038667605513910423,
    105526731046987918957977783508021808,
    1134862593912990427100384996411530433,
    202,
];

fn main(
    email: BoundedVec<u8, 50>,
    data: BoundedVec<u8, MAX_DATA_LENGTH>,
    redc_params_limbs: [u128; 18],
    signature_limbs: [u128; 18],
    base64_decode_offset: u32,
    // expected_nonce: pub BoundedVec<u8, MAX_NONCE_LENGTH>,
) -> pub u64 {
    let jwt = JWT::init(
        data,
        base64_decode_offset,
        PUBKEY_MOD_LIMBS,
        redc_params_limbs,
        signature_limbs,
    );

    jwt.verify();
    // Assert email claim
    jwt.assert_claim_string("email".as_bytes(), email);

    // return iat claim
    jwt.get_claim_number("iat".as_bytes())
}

#[test]
fn test_jwt_verification() {
    // Email from the JWT payload
    let email: BoundedVec<u8, 50> = BoundedVec::from_array("cryspacedao@gmail.com".as_bytes());

    let redc_params_limbs = [
        1140144653512823093899475701461285723,
        825704851577698275444246276973689262,
        371532827314869587469361648224730632,
        16363429691696731592605175948846267,
        560772782707831616965882469004479753,
        792544363607543688640678099978237823,
        431508172340335778515903201711856468,
        523015636092373173445961704778946465,
        92241208970202055179423708959229976,
        932932777820937640710786978697902712,
        788468983492729727800926889604583816,
        900074718540690926232401846350674633,
        8546843257126378368617610457159991,
        559785660892218261034485794387876706,
        1293906089920215775415030075809541367,
        263934945407719525289883505374499385,
        162723603440283465251653023903609155,
        5169,
    ];
    let signature_limbs = [
        647214951030148925360493699090865989,
        417476837794292494279418365544512447,
        985009386845220666118410652122733500,
        786773237199699777468127074574554039,
        100382196663497915908972803815424444,
        439856412646668403601700493674761407,
        1124408212055412610175872571093804856,
        862521544897109566702515233238312210,
        1167035903971708814575534575080881630,
        1009603261774390509196750230636247790,
        1285842694154247518903818523143977737,
        253444453139667947066289029365545687,
        591751962368871864047608101109888633,
        1076245256484399894954619774039048129,
        844869488996054246439999997607629694,
        167160990900123404623329853337119289,
        1099165658979599768945643104037559931,
        158,
    ];
    let data: BoundedVec<u8, 900> = BoundedVec::from_array([
        101, 121, 74, 104, 98, 71, 99, 105, 79, 105, 74, 83, 85, 122, 73, 49, 78, 105, 73, 115, 73,
        110, 82, 53, 99, 67, 73, 54, 73, 107, 112, 88, 86, 67, 73, 115, 73, 109, 116, 112, 90, 67,
        73, 54, 73, 107, 108, 108, 81, 122, 70, 54, 87, 68, 82, 67, 83, 50, 86, 116, 81, 87, 57, 83,
        100, 122, 78, 115, 101, 86, 70, 120, 100, 105, 74, 57, 46, 101, 121, 74, 110, 97, 88, 90,
        108, 98, 108, 57, 117, 89, 87, 49, 108, 73, 106, 111, 105, 81, 51, 74, 53, 85, 51, 66, 104,
        89, 50, 85, 105, 76, 67, 74, 117, 97, 87, 78, 114, 98, 109, 70, 116, 90, 83, 73, 54, 73,
        109, 78, 121, 101, 88, 78, 119, 89, 87, 78, 108, 90, 71, 70, 118, 73, 105, 119, 105, 98,
        109, 70, 116, 90, 83, 73, 54, 73, 107, 78, 121, 101, 86, 78, 119, 89, 87, 78, 108, 73, 105,
        119, 105, 99, 71, 108, 106, 100, 72, 86, 121, 90, 83, 73, 54, 73, 109, 104, 48, 100, 72, 66,
        122, 79, 105, 56, 118, 98, 71, 103, 122, 76, 109, 100, 118, 98, 50, 100, 115, 90, 88, 86,
        122, 90, 88, 74, 106, 98, 50, 53, 48, 90, 87, 53, 48, 76, 109, 78, 118, 98, 83, 57, 104, 76,
        48, 70, 68, 90, 122, 104, 118, 89, 48, 112, 119, 87, 84, 100, 118, 84, 68, 100, 49, 101, 68,
        70, 50, 87, 109, 53, 110, 82, 110, 82, 102, 87, 107, 70, 122, 85, 84, 66, 70, 99, 70, 100,
        116, 100, 86, 85, 120, 90, 50, 81, 116, 81, 48, 57, 121, 89, 51, 99, 49, 77, 50, 108, 73,
        85, 48, 100, 72, 85, 107, 115, 50, 85, 84, 49, 122, 79, 84, 89, 116, 89, 121, 73, 115, 73,
        110, 86, 119, 90, 71, 70, 48, 90, 87, 82, 102, 89, 88, 81, 105, 79, 105, 73, 121, 77, 68,
        73, 49, 76, 84, 69, 120, 76, 84, 73, 121, 86, 68, 69, 49, 79, 106, 73, 119, 79, 106, 65,
        120, 76, 106, 81, 122, 79, 70, 111, 105, 76, 67, 74, 108, 98, 87, 70, 112, 98, 67, 73, 54,
        73, 109, 78, 121, 101, 88, 78, 119, 89, 87, 78, 108, 90, 71, 70, 118, 81, 71, 100, 116, 89,
        87, 108, 115, 76, 109, 78, 118, 98, 83, 73, 115, 73, 109, 86, 116, 89, 87, 108, 115, 88, 51,
        90, 108, 99, 109, 108, 109, 97, 87, 86, 107, 73, 106, 112, 48, 99, 110, 86, 108, 76, 67, 74,
        112, 99, 51, 77, 105, 79, 105, 74, 111, 100, 72, 82, 119, 99, 122, 111, 118, 76, 50, 82,
        108, 100, 105, 49, 115, 100, 68, 69, 52, 99, 51, 77, 120, 78, 122, 70, 120, 90, 88, 107,
        120, 99, 87, 116, 114, 76, 110, 86, 122, 76, 109, 70, 49, 100, 71, 103, 119, 76, 109, 78,
        118, 98, 83, 56, 105, 76, 67, 74, 104, 100, 87, 81, 105, 79, 105, 74, 54, 101, 87, 116, 116,
        99, 108, 66, 87, 77, 86, 89, 48, 89, 109, 48, 122, 79, 87, 82, 73, 85, 110, 66, 70, 84, 68,
        86, 105, 79, 70, 112, 75, 87, 107, 104, 81, 89, 49, 90, 49, 97, 83, 73, 115, 73, 110, 78,
        49, 89, 105, 73, 54, 73, 109, 100, 118, 98, 50, 100, 115, 90, 83, 49, 118, 89, 88, 86, 48,
        97, 68, 74, 56, 77, 84, 69, 49, 77, 68, 103, 121, 79, 84, 107, 122, 78, 106, 73, 122, 79,
        84, 65, 53, 78, 122, 81, 48, 79, 84, 85, 50, 73, 105, 119, 105, 97, 87, 70, 48, 73, 106,
        111, 120, 78, 122, 89, 122, 79, 68, 73, 48, 79, 68, 65, 122, 76, 67, 74, 108, 101, 72, 65,
        105, 79, 106, 69, 51, 78, 106, 77, 52, 78, 106, 65, 52, 77, 68, 77, 115, 73, 110, 78, 112,
        90, 67, 73, 54, 73, 108, 89, 121, 86, 71, 78, 121, 90, 70, 70, 86, 84, 69, 86, 90, 76, 88,
        70, 50, 82, 70, 100, 80, 100, 50, 86, 83, 78, 71, 108, 90, 78, 84, 78, 66, 83, 110, 100, 88,
        97, 68, 70, 110, 73, 105, 119, 105, 98, 109, 57, 117, 89, 50, 85, 105, 79, 105, 74, 106, 87,
        72, 66, 119, 90, 68, 66, 111, 87, 108, 90, 69, 85, 109, 49, 90, 86, 50, 104, 76, 89, 85,
        100, 111, 99, 69, 48, 120, 85, 108, 82, 106, 101, 107, 112, 111, 86, 48, 104, 83, 98, 70,
        78, 114, 84, 107, 49, 108, 86, 49, 90, 54, 86, 86, 90, 71, 84, 109, 81, 122, 86, 107, 78,
        79, 77, 109, 99, 122, 87, 86, 90, 83, 82, 109, 82, 66, 80, 84, 48, 105, 102, 81,
    ]);
    let base64_decode_offset = 77;

    let _ = main(
        email,
        data,
        base64_decode_offset,
        redc_params_limbs,
        signature_limbs,
        // expected_nonce
    );
}
